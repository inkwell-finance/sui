{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { Oracle } from \"./oracle/index.js\";\nimport type { QueueData } from \"./queue/index.js\";\nimport { Queue } from \"./queue/index.js\";\nimport { State } from \"./state/index.js\";\n\nimport { TTLCache } from \"@brokerloop/ttlcache\";\nimport type {\n  MoveStruct,\n  MoveValue,\n  SuiObjectResponse,\n} from \"@mysten/sui/client\";\nimport type { SuiClient } from \"@mysten/sui/client\";\nimport type { Queue as SolanaQueue } from \"@switchboard-xyz/on-demand\";\nimport BN from \"bn.js\";\n\nexport { Oracle, Queue, State };\n\nexport * from \"./aggregator/index.js\";\nexport * from \"./oracle/index.js\";\nexport * from \"./queue/index.js\";\nexport * from \"./state/index.js\";\nexport * from \"@switchboard-xyz/on-demand\";\n\nexport const ON_DEMAND_MAINNET_OBJECT_PACKAGE_ID =\n  \"0xc3c7e6eb7202e9fb0389a2f7542b91cc40e4f7a33c02554fec11c4c92f938ea3\";\nexport const ON_DEMAND_MAINNET_STATE_OBJECT_ID =\n  \"0x93d2a8222bb2006d16285ac858ec2ae5f644851917504b94debde8032664a791\";\nexport const ON_DEMAND_TESTNET_OBJECT_PACKAGE_ID =\n  \"0xdd96e1c8d6d61c4642b9b73eefb1021cc5f93f489b794bca11c81d55fcf43ce2\";\nexport const ON_DEMAND_TESTNET_STATE_OBJECT_ID =\n  \"0x2086fdde07a8f4726a3fc72d6ef1021343a781d42de6541ca412cf50b4339ad6\";\n\n// ==============================================================================\n// Caching for Fetch Update Ix\n\n// 1 min cache for sui cache\nexport const suiQueueCache = new TTLCache<string, QueueData>({\n  ttl: 1000 * 60,\n});\n\n// 5 min solana queue cache - reloads the sol program every 5 minutes max\nexport const solanaProgramCache = new TTLCache<string, SolanaQueue>({\n  ttl: 1000 * 60 * 5,\n});\n\n// ==============================================================================\n\nexport interface SwitchboardState {\n  switchboardAddress: string;\n  guardianQueueId: string;\n  oracleQueueId: string;\n  mainnet: boolean;\n}\n\nexport interface CommonOptions {\n  switchboardAddress?: string;\n  stateObjectId?: string;\n  guardianQueueId?: string;\n  oracleQueueId?: string;\n  chainId?: string;\n}\n\nexport class SwitchboardClient {\n  state: Promise<SwitchboardState | undefined>;\n\n  constructor(readonly client: SuiClient, options?: CommonOptions) {\n    this.state = getSwitchboardState(client, options);\n  }\n\n  /**\n   * Fetch the current state of the Switchboard (on-demand package ID, guardian queue ID, oracle queue ID)\n   * @param retries Number of retries to fetch the state\n   */\n  async fetchState(\n    options?: CommonOptions,\n    retries: number = 3\n  ): Promise<SwitchboardState> {\n    if (retries <= 0) {\n      throw new Error(\n        \"Failed to fetch Switchboard state after multiple attempts\"\n      );\n    }\n\n    try {\n      const state = await this.state;\n      if (!state) {\n        this.state = getSwitchboardState(this.client, options);\n        return this.fetchState(options, retries - 1);\n      }\n\n      return {\n        switchboardAddress:\n          options?.switchboardAddress ?? state.switchboardAddress,\n        guardianQueueId: options?.guardianQueueId ?? state.guardianQueueId,\n        oracleQueueId: options?.oracleQueueId ?? state.oracleQueueId,\n        mainnet: state.mainnet,\n      };\n    } catch (error) {\n      console.error(\"Error fetching Switchboard state, retrying...\");\n      return this.fetchState(options, retries - 1);\n    }\n  }\n}\n\n// Helper function to get the Switchboard state\nexport async function getSwitchboardState(\n  client: SuiClient,\n  options?: CommonOptions\n): Promise<SwitchboardState | undefined> {\n  try {\n    const chainId = options?.chainId ?? (await client.getChainIdentifier());\n    const mainnet = chainId !== \"4c78adac\"; // Check if mainnet or testnet\n    console.log(\"Chain ID:\", chainId);\n    console.log(\"Mainnet:\", mainnet);\n    console.log(\"Options:\", options);\n    const stateObjectId = options?.stateObjectId ?? (mainnet ? ON_DEMAND_MAINNET_STATE_OBJECT_ID : ON_DEMAND_TESTNET_STATE_OBJECT_ID);\n    console.log(\"State Object ID:\", stateObjectId);\n    const data = await State.fetch(\n      client,\n      stateObjectId\n    );\n\n    return {\n      switchboardAddress: options?.switchboardAddress ?? data.onDemandPackageId,\n      guardianQueueId: options?.guardianQueueId ?? data.guardianQueue,\n      oracleQueueId: options?.oracleQueueId ?? data.oracleQueue,\n      mainnet,\n    };\n  } catch (error) {\n    console.error(\"Failed to retrieve Switchboard state:\", error);\n  }\n}\n\nexport function getFieldsFromObject(response: SuiObjectResponse): {\n  [key: string]: MoveValue;\n} {\n  console.log(\"Response:\", response);\n  // Check if 'data' and 'content' exist and are of the expected type\n  if (\n    response.data?.content &&\n    response.data.content.dataType === \"moveObject\" &&\n    !Array.isArray(response.data.content.fields) &&\n    !(\"type\" in response.data.content.fields)\n  ) {\n    // Safely return 'fields' from 'content'\n    return response.data.content.fields;\n  }\n\n  throw new Error(\"Invalid response data\");\n}\n\nexport class ObjectParsingHelper {\n  public static asString(value: MoveValue): string {\n    if (typeof value === \"string\") {\n      return value;\n    }\n    throw new Error(\"Invalid Move String\");\n  }\n\n  public static asNumber(value: MoveValue): number {\n    try {\n      return parseInt(value as string);\n    } catch (e) {\n      throw new Error(\"Invalid Move Number\");\n    }\n  }\n\n  public static asArray(value: MoveValue): MoveValue[] {\n    if (Array.isArray(value)) {\n      return value;\n    }\n    throw new Error(\"Invalid MoveValueArray\");\n  }\n\n  public static asUint8Array(value: MoveValue): Uint8Array {\n    if (Array.isArray(value) && value.every((v) => typeof v === \"number\")) {\n      return new Uint8Array(value as number[]);\n    }\n    throw new Error(\"Invalid Move Uint8Array\");\n  }\n\n  public static asId(value: MoveValue): string {\n    if (typeof value === \"object\" && \"id\" in value) {\n      const idWrapper = value as { id: string };\n      return idWrapper.id;\n    }\n    throw new Error(\"Invalid Move Id\");\n  }\n\n  public static asStruct(value: MoveValue): MoveStruct {\n    if (typeof value === \"object\" && !Array.isArray(value)) {\n      return value as MoveStruct;\n    }\n    throw new Error(\"Invalid Move Struct\");\n  }\n\n  // Parse switchboard move decimal into BN, whether or not nested in \"fields\"\n  public static asBN(value: MoveValue): BN {\n    if (typeof value !== \"object\") {\n      throw new Error(\"Invalid Move BN Input Type\");\n    }\n\n    const target = \"fields\" in value ? value.fields : value;\n\n    if (typeof target === \"object\" && \"value\" in target && \"neg\" in target) {\n      return new BN(target.value.toString()).mul(\n        target.neg ? new BN(-1) : new BN(1)\n      );\n    }\n\n    throw new Error(\"Invalid Move BN\");\n  }\n}\n"]}